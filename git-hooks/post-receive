#!/bin/bash

# Git Post-receive Hook for Auto Deploy
# Place this file in: /path/to/your/bare/repo.git/hooks/post-receive
# Make it executable: chmod +x post-receive

# Configuration
DEPLOY_DIR="/var/www/kpi-tracker"  # Change to your actual deploy directory
BRANCH="main"                     # Branch to deploy
LOG_FILE="$DEPLOY_DIR/deployment.log"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Logging function
log() {
    echo -e "${GREEN}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1" | tee -a "$LOG_FILE"
}

log_error() {
    echo -e "${RED}[$(date '+%Y-%m-%d %H:%M:%S')] ERROR:${NC} $1" | tee -a "$LOG_FILE"
}

log_warning() {
    echo -e "${YELLOW}[$(date '+%Y-%m-%d %H:%M:%S')] WARNING:${NC} $1" | tee -a "$LOG_FILE"
}

# Read the push information
while read oldrev newrev refname; do
    # Extract branch name
    branch=$(git rev-parse --symbolic --abbrev-ref $refname)
    
    log "üîÑ Received push to branch: $branch"
    
    # Only deploy if push is to the main branch
    if [ "$branch" = "$BRANCH" ]; then
        log "üöÄ Starting deployment for branch: $branch"
        
        # Change to deployment directory
        cd "$DEPLOY_DIR" || {
            log_error "Failed to change to deployment directory: $DEPLOY_DIR"
            exit 1
        }
        
        # Backup current state (optional)
        log "üíæ Creating backup..."
        if [ -d ".git" ]; then
            git stash push -m "Auto-backup before deploy $(date)" || log_warning "Stash failed"
        fi
        
        # Pull the latest changes
        log "üì• Pulling latest changes..."
        git --git-dir="$DEPLOY_DIR/.git" --work-tree="$DEPLOY_DIR" pull origin "$BRANCH" || {
            log_error "Git pull failed"
            exit 1
        }
        
        # Stop existing containers
        log "üõë Stopping existing containers..."
        docker compose down || log_warning "Docker compose down failed"
        
        # Clean up Docker resources
        log "üßπ Cleaning up Docker resources..."
        docker system prune -f
        docker builder prune -f
        docker container prune -f
        
        # Build and start new containers
        log "üî® Building and starting containers..."
        docker compose up -d --build --force-recreate || {
            log_error "Docker compose up failed"
            exit 1
        }
        
        # Wait for services to start
        log "‚è≥ Waiting for services to start..."
        sleep 10
        
        # Final cleanup
        log "üßπ Final cleanup..."
        docker image prune -f
        
        # Health check
        log "üè• Performing health check..."
        if docker compose ps | grep -q "Up"; then
            log "‚úÖ Deployment successful! Services are running."
            
            # Show container status
            log "üìä Container status:"
            docker compose ps | tee -a "$LOG_FILE"
            
            # Show recent logs
            log "üìã Recent application logs:"
            docker compose logs --tail=10 | tee -a "$LOG_FILE"
            
        else
            log_error "‚ùå Deployment failed! Services are not running properly."
            docker compose logs --tail=20 | tee -a "$LOG_FILE"
            exit 1
        fi
        
        log "üéâ Deployment completed successfully!"
        
    else
        log "‚ÑπÔ∏è  Push to branch '$branch' ignored. Only '$BRANCH' branch triggers deployment."
    fi
done

exit 0