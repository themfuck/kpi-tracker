# Before running: Generate APP_KEY with: docker run --rm kpi-tracker:prod php artisan key:generate --show
# Then set it in your .env or export APP_KEY=base64:...

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: kpi-tracker:prod
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - APP_URL=https://kpi.optimus-code.com
      - APP_KEY=${APP_KEY}
      - DB_CONNECTION=sqlite
      # Ensure SQLite uses the persistent volume
      - DB_DATABASE=/var/www/html/storage/database.sqlite
      # - DATABASE_URL=${DATABASE_URL}
    volumes:
      # Mount app code for live updates (development)
      - ./app:/var/www/html/app
      - ./config:/var/www/html/config
      - ./routes:/var/www/html/routes
      - ./resources:/var/www/html/resources
      - ./database:/var/www/html/database
      # Persist storage folder (uploads, logs, sqlite db if used there)
      - ./storage:/var/www/html/storage
    ports:
      # TEMPORARY: Remove after DNS is configured
      - "8080:80"
    labels:
      - "traefik.enable=true"
      
      # HTTP Router (Redirect to HTTPS)
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-kpi-tracker}-http.entrypoints=web"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-kpi-tracker}-http.rule=Host(`kpi.optimus-code.com`)"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-kpi-tracker}-http.middlewares=${COMPOSE_PROJECT_NAME:-kpi-tracker}-https-redirect"
      
      # Middleware for HTTPS Redirect
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME:-kpi-tracker}-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME:-kpi-tracker}-https-redirect.redirectscheme.permanent=true"
      
      # HTTPS Router
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-kpi-tracker}-https.entrypoints=websecure"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-kpi-tracker}-https.rule=Host(`kpi.optimus-code.com`)"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-kpi-tracker}-https.tls=true"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME:-kpi-tracker}-https.tls.certresolver=myresolver"
      
      # Service Port (Container listens on 80)
      - "traefik.http.services.${COMPOSE_PROJECT_NAME:-kpi-tracker}.loadbalancer.server.port=80"

    restart: unless-stopped
    networks:
      - traefik

networks:
  traefik:
    external: true
    name: ${TRAEFIK_NETWORK:-nginx-proxy}
